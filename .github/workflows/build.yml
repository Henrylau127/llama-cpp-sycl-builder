name: Weekly llama.cpp SYCL build (linux/amd64)

on:
  schedule:
    # Weekly: Mondays 02:00 UTC
    - cron: "0 2 * * 1"
  workflow_dispatch: {}

permissions:
  contents: write
  packages: write

env:
  UPSTREAM_OWNER: ggml-org
  UPSTREAM_REPO: llama.cpp
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}   # ghcr.io/<owner>/<repo>

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout builder repo (for state file)
        uses: actions/checkout@v4

      - name: Get latest upstream release tag
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch latest release tag, e.g. "b5377"
          TAG=$(gh api repos/${UPSTREAM_OWNER}/${UPSTREAM_REPO}/releases/latest --jq .tag_name)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Read last built tag
        id: last
        run: |
          if [ -f .last_built_tag ]; then
            echo "tag=$(cat .last_built_tag)" >> "$GITHUB_OUTPUT"
          else
            echo "tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Decide whether to build
        id: decide
        run: |
          if [ "${{ steps.upstream.outputs.tag }}" = "${{ steps.last.outputs.tag }}" ]; then
            echo "build=false" >> "$GITHUB_OUTPUT"
          else
            echo "build=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Stop early (no new release)
        if: steps.decide.outputs.build != 'true'
        run: echo "No new upstream release tag; skipping."

      - name: Free disk space (needed for oneAPI/SYCL builds)
        if: steps.decide.outputs.build == 'true'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true

      - name: Checkout upstream llama.cpp at that tag
        if: steps.decide.outputs.build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_OWNER }}/${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.upstream.outputs.tag }}
          path: llama.cpp

      - name: Log in to GHCR
        if: steps.decide.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        if: steps.decide.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Build & push SYCL image (linux/amd64)
        if: steps.decide.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./llama.cpp
          file: ./llama.cpp/.devops/intel.Dockerfile
          target: light
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.upstream.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          build-args: |
            GGML_SYCL_F16=ON

      - name: Record last built tag
        if: steps.decide.outputs.build == 'true'
        run: |
          echo "${{ steps.upstream.outputs.tag }}" > .last_built_tag

      - name: Commit state file
        if: steps.decide.outputs.build == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .last_built_tag
          git commit -m "ci: built llama.cpp ${{ steps.upstream.outputs.tag }}" || exit 0
          git push
